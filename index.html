<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة Tags و Candat</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4b0082;
            --secondary-color: #8a2be2;
            --accent-color: #e91e63;
            --light-color: #f3e5f5;
            --dark-color: #2a0047;
            --text-color: #ffffff;
            --bg-color: #1a1a1a;
            --card-bg: #2a2a2a;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --fire-effect: 0 0 10px rgba(255, 69, 0, 0.8), 0 0 20px rgba(255, 165, 0, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }

        body {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('https://picsum.photos/1920/1080');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-color);
            min-height: 100vh;
            position: relative;
        }

        .container {
            display: grid;
            grid-template-columns: 250px 1fr 250px;
            grid-template-rows: auto 1fr;
            min-height: 100vh;
        }

        header {
            grid-column: 1 / -1;
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--fire-effect);
            border-bottom: 2px solid var(--secondary-color);
        }

        header h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 5px var(--secondary-color);
        }

        .btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }

        .btn:hover {
            background-color: #9932cc;
            transform: translateY(-2px);
            box-shadow: var(--fire-effect);
        }

        .sidebar, .candat-sidebar {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 1rem;
            overflow-y: auto;
        }

        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-box input {
            width: 100%;
            padding: 0.5rem 1rem 0.5rem 2rem;
            border-radius: 25px;
            border: 1px solid var(--secondary-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 16px;
        }

        .search-box input:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(138, 43, 226, 0.5);
        }

        .search-box i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
        }

        .categories-list, .candat-categories-list {
            list-style: none;
        }

        .categories-list li, .candat-categories-list li {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid transparent;
        }

        .candat-categories-list li.subcategory {
            padding-right: 1.5rem;
            font-size: 0.9rem;
        }

        .categories-list li:hover, .candat-categories-list li:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-left-color: var(--secondary-color);
        }

        .categories-list li.active, .candat-categories-list li.active {
            background-color: var(--secondary-color);
            font-weight: bold;
            border-left-color: var(--accent-color);
        }

        .control-panel-btn {
            background-color: var(--accent-color);
            padding: 0.75rem;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-panel-btn:hover {
            background-color: #c2185b;
            box-shadow: var(--fire-effect);
        }

        main {
            padding: 1rem;
            overflow-y: auto;
        }

        .tags-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .tag-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--shadow);
            transition: all 0.3s;
            cursor: pointer;
            border-left: 4px solid var(--secondary-color);
        }

        .tag-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--fire-effect);
        }

        .tag-card h3 {
            margin-bottom: 0.5rem;
            color: var(--secondary-color);
            font-size: 1.1rem;
        }

        .tag-card p {
            color: var(--text-color);
            font-size: 0.9rem;
            white-space: pre-line;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--secondary-color);
            box-shadow: var(--fire-effect);
        }

        .modal-content h2 {
            margin-bottom: 1rem;
            color: var(--secondary-color);
            text-align: center;
        }

        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .modal-content input:focus,
        .modal-content select:focus,
        .modal-content textarea:focus {
            outline: none;
            box-shadow: 0 0 5px rgba(138, 43, 226, 0.5);
        }

        .modal-content textarea {
            min-height: 100px;
            resize: vertical;
        }

        .close {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--secondary-color);
            transition: all 0.2s;
        }

        .close:hover {
            color: #ff5722;
            transform: rotate(90deg);
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--secondary-color);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 1000;
            transform: translateX(150%);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .control-panel {
            display: none;
            flex-direction: column;
            gap: 1rem;
            background-color: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid var(--secondary-color);
        }

        .control-panel.show {
            display: flex;
        }

        .control-panel .btn {
            width: 100%;
            justify-content: center;
        }

        .tag-actions {
            position: absolute;
            top: 5px;
            left: 5px;
            display: flex;
            gap: 5px;
        }

        .tag-actions button {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .tag-actions button:hover {
            color: var(--accent-color);
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            .sidebar, .candat-sidebar {
                display: none;
            }
            .tags-container {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tags"></i> نظام إدارة Tags و Candat</h1>
        </header>

        <div class="candat-sidebar">
            <div class="search-box">
                <input type="text" id="candatSearchInput" placeholder="ابحث عن Candat...">
                <i class="fas fa-search"></i>
            </div>
            <ul id="candatCategoriesList" class="candat-categories-list"></ul>
            <div class="control-panel-btn" data-panel="candat">
                <i class="fas fa-cog"></i> لوحة تحكم Candat
            </div>
        </div>

        <main>
            <div id="tagsContainer" class="tags-container"></div>
        </main>

        <div class="sidebar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ابحث عن Tags...">
                <i class="fas fa-search"></i>
            </div>
            <ul id="categoriesList" class="categories-list"></ul>
            <div class="control-panel-btn" data-panel="tags">
                <i class="fas fa-cog"></i> لوحة تحكم Tags
            </div>
        </div>

        <!-- Password Modal -->
        <div id="passwordModal" class="modal">
            <div class="modal-content">
                <span class="close">×</span>
                <h2>إدخال كلمة المرور</h2>
                <input type="password" id="passwordInput" placeholder="أدخل كلمة المرور">
                <button id="confirmPassword" class="btn">تأكيد</button>
            </div>
        </div>

        <!-- Category Modal -->
        <div id="categoryModal" class="modal">
            <div class="modal-content">
                <span class="close">×</span>
                <h2 id="modalCategoryTitle">إضافة قسم جديد</h2>
                <input type="text" id="categoryName" placeholder="اسم القسم">
                <select id="parentCategory">
                    <option value="">لا يوجد قسم رئيسي</option>
                </select>
                <button id="saveCategory" class="btn">حفظ</button>
            </div>
        </div>

        <!-- Item Modal -->
        <div id="itemModal" class="modal">
            <div class="modal-content">
                <span class="close">×</span>
                <h2 id="modalItemTitle">إضافة عنصر جديد</h2>
                <select id="itemCategory"></select>
                <input type="text" id="itemName" placeholder="اسم العنصر">
                <textarea id="itemContent" placeholder="محتوى العنصر"></textarea>
                <button id="saveItem" class="btn">حفظ</button>
            </div>
        </div>

        <!-- Notification -->
        <div id="notification" class="notification"></div>

        <!-- Control Panel -->
        <div id="controlPanel" class="control-panel">
            <button id="addCategory" class="btn"><i class="fas fa-folder-plus"></i> إضافة قسم</button>
            <button id="addItem" class="btn"><i class="fas fa-tag"></i> إضافة عنصر</button>
            <button id="exportExcel" class="btn"><i class="fas fa-file-export"></i> تصدير Excel</button>
            <button id="importExcel" class="btn"><i class="fas fa-file-import"></i> استيراد Excel</button>
            <input type="file" id="excelFileInput" accept=".xlsx,.csv" style="display: none;">
            <button id="exportJson" class="btn"><i class="fas fa-file-download"></i> تصدير JSON</button>
            <button id="importJson" class="btn"><i class="fas fa-file-upload"></i> استيراد JSON</button>
            <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
            <input type="password" id="newPassword" placeholder="تغيير كلمة المرور">
            <button id="changePassword" class="btn"><i class="fas fa-key"></i> حفظ كلمة المرور</button>
            <button id="closeControlPanel" class="btn"><i class="fas fa-times"></i> إغلاق</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Application state
            let appData = {
                tags: { categories: [], currentCategory: null, editingCategory: null, editingItem: null },
                candat: { categories: [], currentCategory: null, editingCategory: null, editingItem: null }
            };
            let currentPanel = 'tags';
            const defaultPassword = 'admin123';
            let storedPassword = localStorage.getItem('controlPanelPassword') || defaultPassword;

            // DOM elements
            const elements = {
                categoriesList: document.getElementById('categoriesList'),
                candatCategoriesList: document.getElementById('candatCategoriesList'),
                tagsContainer: document.getElementById('tagsContainer'),
                searchInput: document.getElementById('searchInput'),
                candatSearchInput: document.getElementById('candatSearchInput'),
                controlPanel: document.getElementById('controlPanel'),
                controlPanelBtns: document.querySelectorAll('.control-panel-btn'),
                addCategory: document.getElementById('addCategory'),
                addItem: document.getElementById('addItem'),
                exportExcel: document.getElementById('exportExcel'),
                importExcel: document.getElementById('importExcel'),
                excelFileInput: document.getElementById('excelFileInput'),
                exportJson: document.getElementById('exportJson'),
                importJson: document.getElementById('importJson'),
                jsonFileInput: document.getElementById('jsonFileInput'),
                passwordModal: document.getElementById('passwordModal'),
                passwordInput: document.getElementById('passwordInput'),
                confirmPassword: document.getElementById('confirmPassword'),
                newPassword: document.getElementById('newPassword'),
                changePassword: document.getElementById('changePassword'),
                closeControlPanel: document.getElementById('closeControlPanel'),
                categoryModal: document.getElementById('categoryModal'),
                modalCategoryTitle: document.getElementById('modalCategoryTitle'),
                categoryName: document.getElementById('categoryName'),
                parentCategory: document.getElementById('parentCategory'),
                saveCategory: document.getElementById('saveCategory'),
                itemModal: document.getElementById('itemModal'),
                modalItemTitle: document.getElementById('modalItemTitle'),
                itemCategory: document.getElementById('itemCategory'),
                itemName: document.getElementById('itemName'),
                itemContent: document.getElementById('itemContent'),
                saveItem: document.getElementById('saveItem'),
                notification: document.getElementById('notification')
            };

            // Initialize application
            async function initApp() {
                await loadData();
                setupEventListeners();
                renderCategories();
                renderCandatCategories();
                renderItems();
            }

            // Load data from data.json
            async function loadData() {
                try {
                    const response = await fetch('data.json', { cache: 'no-store' });
                    if (!response.ok) throw new Error('فشل تحميل البيانات');
                    const jsonData = await response.json();
                    appData.tags = jsonData.tags || { categories: [], currentCategory: null };
                    appData.candat = jsonData.candat || { categories: [], currentCategory: null };
                    if (appData.tags.categories.length > 0) appData.tags.currentCategory = appData.tags.categories[0].id;
                    if (appData.candat.categories.length > 0) appData.candat.currentCategory = appData.candat.categories[0].id;
                    showNotification('تم تحميل البيانات بنجاح');
                } catch (error) {
                    showNotification('فشل تحميل البيانات، سيتم استخدام بيانات افتراضية');
                    appData = {
                        tags: { categories: [], currentCategory: null, editingCategory: null, editingItem: null },
                        candat: { categories: [], currentCategory: null, editingCategory: null, editingItem: null }
                    };
                }
            }

            // Save data to server (simulated)
            async function saveData() {
                try {
                    const response = await fetch('save_data.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(appData)
                    });
                    if (!response.ok) throw new Error('فشل حفظ البيانات');
                    showNotification('تم حفظ البيانات بنجاح');
                } catch (error) {
                    showNotification('فشل حفظ البيانات');
                }
            }

            // Setup event listeners
            function setupEventListeners() {
                elements.controlPanelBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        currentPanel = btn.dataset.panel;
                        elements.passwordModal.style.display = 'flex';
                        elements.passwordInput.focus();
                    });
                });

                elements.confirmPassword.addEventListener('click', () => {
                    if (elements.passwordInput.value === storedPassword) {
                        elements.passwordModal.style.display = 'none';
                        elements.controlPanel.classList.add('show');
                        showNotification(`تم فتح لوحة تحكم ${currentPanel === 'tags' ? 'Tags' : 'Candat'}`);
                    } else {
                        showNotification('كلمة المرور غير صحيحة');
                    }
                });

                elements.changePassword.addEventListener('click', () => {
                    const newPassword = elements.newPassword.value.trim();
                    if (newPassword) {
                        storedPassword = newPassword;
                        localStorage.setItem('controlPanelPassword', storedPassword);
                        showNotification('تم تغيير كلمة المرور');
                        elements.newPassword.value = '';
                    } else {
                        showNotification('أدخل كلمة مرور جديدة');
                    }
                });

                elements.closeControlPanel.addEventListener('click', () => {
                    elements.controlPanel.classList.remove('show');
                    showNotification('تم إغلاق لوحة التحكم');
                });

                elements.addCategory.addEventListener('click', () => {
                    appData[currentPanel].editingCategory = null;
                    elements.modalCategoryTitle.textContent = 'إضافة قسم جديد';
                    elements.categoryName.value = '';
                    updateParentCategoryDropdown();
                    elements.categoryModal.style.display = 'flex';
                });

                elements.addItem.addEventListener('click', () => {
                    if (!appData[currentPanel].currentCategory) {
                        showNotification('اختر قسمًا أولاً');
                        return;
                    }
                    appData[currentPanel].editingItem = null;
                    elements.modalItemTitle.textContent = `إضافة ${currentPanel === 'tags' ? 'Tag' : 'Candat'} جديد`;
                    elements.itemName.value = '';
                    elements.itemContent.value = '';
                    updateItemCategoryDropdown();
                    elements.itemModal.style.display = 'flex';
                });

                elements.exportExcel.addEventListener('click', exportToExcel);
                elements.importExcel.addEventListener('click', () => elements.excelFileInput.click());
                elements.excelFileInput.addEventListener('change', importFromExcel);
                elements.exportJson.addEventListener('click', exportToJson);
                elements.importJson.addEventListener('click', () => elements.jsonFileInput.click());
                elements.jsonFileInput.addEventListener('change', importFromJson);

                elements.saveCategory.addEventListener('click', async () => {
                    await saveCategory();
                    await saveData();
                });
                elements.saveItem.addEventListener('click', async () => {
                    await saveItem();
                    await saveData();
                });

                elements.searchInput.addEventListener('input', () => {
                    currentPanel = 'tags';
                    renderItems(elements.searchInput.value.toLowerCase());
                });
                elements.candatSearchInput.addEventListener('input', () => {
                    currentPanel = 'candat';
                    renderItems(elements.candatSearchInput.value.toLowerCase());
                });

                document.querySelectorAll('.close').forEach(closeBtn => {
                    closeBtn.addEventListener('click', () => closeBtn.closest('.modal').style.display = 'none');
                });

                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) e.target.style.display = 'none';
                });

                document.addEventListener('contextmenu', (e) => e.preventDefault());
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                        showNotification('أدوات المطورين غير مسموح بها');
                        e.preventDefault();
                    }
                });
            }

            // Render Tags categories
            function renderCategories() {
                elements.categoriesList.innerHTML = '';
                appData.tags.categories.forEach(category => {
                    const li = document.createElement('li');
                    li.className = category.id === appData.tags.currentCategory ? 'active' : '';
                    li.innerHTML = `
                        <span>${category.name}</span>
                        <div class="actions">
                            <button class="edit" data-id="${category.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete" data-id="${category.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    li.addEventListener('click', (e) => {
                        if (!e.target.closest('.actions')) {
                            appData.tags.currentCategory = category.id;
                            currentPanel = 'tags';
                            renderCategories();
                            renderItems();
                        }
                    });
                    li.querySelector('.edit').addEventListener('click', () => {
                        if (!elements.controlPanel.classList.contains('show')) {
                            showNotification('افتح لوحة التحكم أولاً');
                            return;
                        }
                        appData.tags.editingCategory = category.id;
                        elements.modalCategoryTitle.textContent = 'تحرير القسم';
                        elements.categoryName.value = category.name;
                        updateParentCategoryDropdown();
                        elements.categoryModal.style.display = 'flex';
                    });
                    li.querySelector('.delete').addEventListener('click', async () => {
                        if (!elements.controlPanel.classList.contains('show')) {
                            showNotification('افتح لوحة التحكم أولاً');
                            return;
                        }
                        if (confirm(`هل تريد حذف "${category.name}"؟`)) {
                            appData.tags.categories = appData.tags.categories.filter(c => c.id !== category.id);
                            if (appData.tags.currentCategory === category.id) {
                                appData.tags.currentCategory = appData.tags.categories[0]?.id || null;
                            }
                            renderCategories();
                            renderItems();
                            await saveData();
                            showNotification('تم الحذف');
                        }
                    });
                    elements.categoriesList.appendChild(li);
                });
            }

            // Render Candat categories
            function renderCandatCategories() {
                elements.candatCategoriesList.innerHTML = '';
                const mainCategories = appData.candat.categories.filter(c => !c.parentId);
                mainCategories.forEach(category => {
                    const li = document.createElement('li');
                    li.className = category.id === appData.candat.currentCategory ? 'active' : '';
                    li.innerHTML = `
                        <span>${category.name}</span>
                        <div class="actions">
                            <button class="edit" data-id="${category.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete" data-id="${category.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    li.addEventListener('click', (e) => {
                        if (!e.target.closest('.actions')) {
                            appData.candat.currentCategory = category.id;
                            currentPanel = 'candat';
                            renderCandatCategories();
                            renderItems();
                        }
                    });
                    li.querySelector('.edit').addEventListener('click', () => {
                        if (!elements.controlPanel.classList.contains('show')) {
                            showNotification('افتح لوحة التحكم أولاً');
                            return;
                        }
                        appData.candat.editingCategory = category.id;
                        elements.modalCategoryTitle.textContent = 'تحرير القسم';
                        elements.categoryName.value = category.name;
                        updateParentCategoryDropdown(category.parentId);
                        elements.categoryModal.style.display = 'flex';
                    });
                    li.querySelector('.delete').addEventListener('click', async () => {
                        if (!elements.controlPanel.classList.contains('show')) {
                            showNotification('افتح لوحة التحكم أولاً');
                            return;
                        }
                        if (confirm(`هل تريد حذف "${category.name}"؟`)) {
                            appData.candat.categories = appData.candat.categories.filter(c => c.id !== category.id && c.parentId !== category.id);
                            if (appData.candat.currentCategory === category.id) {
                                appData.candat.currentCategory = appData.candat.categories[0]?.id || null;
                            }
                            renderCandatCategories();
                            renderItems();
                            await saveData();
                            showNotification('تم الحذف');
                        }
                    });
                    elements.candatCategoriesList.appendChild(li);

                    const subCategories = appData.candat.categories.filter(c => c.parentId === category.id);
                    subCategories.forEach(subCategory => {
                        const subLi = document.createElement('li');
                        subLi.className = `subcategory ${subCategory.id === appData.candat.currentCategory ? 'active' : ''}`;
                        subLi.innerHTML = `
                            <span>${subCategory.name}</span>
                            <div class="actions">
                                <button class="edit" data-id="${subCategory.id}"><i class="fas fa-edit"></i></button>
                                <button class="delete" data-id="${subCategory.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        subLi.addEventListener('click', (e) => {
                            if (!e.target.closest('.actions')) {
                                appData.candat.currentCategory = subCategory.id;
                                currentPanel = 'candat';
                                renderCandatCategories();
                                renderItems();
                            }
                        });
                        subLi.querySelector('.edit').addEventListener('click', () => {
                            if (!elements.controlPanel.classList.contains('show')) {
                                showNotification('افتح لوحة التحكم أولاً');
                                return;
                            }
                            appData.candat.editingCategory = subCategory.id;
                            elements.modalCategoryTitle.textContent = 'تحرير القسم';
                            elements.categoryName.value = subCategory.name;
                            updateParentCategoryDropdown(subCategory.parentId);
                            elements.categoryModal.style.display = 'flex';
                        });
                        subLi.querySelector('.delete').addEventListener('click', async () => {
                            if (!elements.controlPanel.classList.contains('show')) {
                                showNotification('افتح لوحة التحكم أولاً');
                                return;
                            }
                            if (confirm(`هل تريد حذف "${subCategory.name}"؟`)) {
                                appData.candat.categories = appData.candat.categories.filter(c => c.id !== subCategory.id);
                                if (appData.candat.currentCategory === subCategory.id) {
                                    appData.candat.currentCategory = appData.candat.categories[0]?.id || null;
                                }
                                renderCandatCategories();
                                renderItems();
                                await saveData();
                                showNotification('تم الحذف');
                            }
                        });
                        elements.candatCategoriesList.appendChild(subLi);
                    });
                });
            }

            // Render items
            function renderItems(searchTerm = '') {
                elements.tagsContainer.innerHTML = '';
                const data = appData[currentPanel];
                if (searchTerm) {
                    const filteredItems = [];
                    data.categories.forEach(category => {
                        const matchingItems = category.items.filter(item =>
                            item.name.toLowerCase().includes(searchTerm) ||
                            item.content.toLowerCase().includes(searchTerm)
                        ).map(item => ({ ...item, categoryName: category.name }));
                        filteredItems.push(...matchingItems);
                    });

                    if (filteredItems.length === 0) {
                        elements.tagsContainer.innerHTML = '<p style="text-align: center; grid-column: 1 / -1;">لا توجد عناصر</p>';
                        return;
                    }

                    filteredItems.forEach(item => {
                        const card = createItemCard(item, item.categoryName);
                        elements.tagsContainer.appendChild(card);
                    });
                } else {
                    const currentCategory = data.categories.find(c => c.id === data.currentCategory);
                    if (!currentCategory) {
                        elements.tagsContainer.innerHTML = '<p style="text-align: center; grid-column: 1 / -1;">اختر قسمًا</p>';
                        return;
                    }
                    if (currentCategory.items.length === 0) {
                        elements.tagsContainer.innerHTML = '<p style Logos style="text-align: center; grid-column: 1 / -1;">لا توجد عناصر</p>';
                        return;
                    }
                    currentCategory.items.forEach(item => {
                        const card = createItemCard(item, currentCategory.name);
                        elements.tagsContainer.appendChild(card);
                    });
                }
            }

            // Create item card
            function createItemCard(item, categoryName) {
                const card = document.createElement('div');
                card.className = 'tag-card';
                card.innerHTML = `
                    <div class="tag-actions">
                        <button class="edit" data-id="${item.id}" data-category="${categoryName}"><i class="fas fa-edit"></i></button>
                        <button class="delete" data-id="${item.id}" data-category="${categoryName}"><i class="fas fa-trash"></i></button>
                    </div>
                    <h3>${item.name} (${categoryName})</h3>
                    <p>${item.content}</p>
                `;
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.tag-actions')) {
                        copyToClipboard(item.content);
                        card.style.backgroundColor = 'rgba(138, 43, 226, 0.2)';
                        setTimeout(() => card.style.backgroundColor = 'var(--card-bg)', 300);
                    }
                });
                card.querySelector('.edit').addEventListener('click', () => {
                    if (!elements.controlPanel.classList.contains('show')) {
                        showNotification('افتح لوحة التحكم أولاً');
                        return;
                    }
                    const category = appData[currentPanel].categories.find(c => c.name === categoryName);
                    const targetItem = category.items.find(i => i.id === item.id);
                    appData[currentPanel].editingItem = { categoryId: category.id, itemId: item.id };
                    elements.modalItemTitle.textContent = `تحرير ${currentPanel === 'tags' ? 'Tag' : 'Candat'}`;
                    elements.itemName.value = targetItem.name;
                    elements.itemContent.value = targetItem.content;
                    updateItemCategoryDropdown();
                    elements.itemModal.style.display = 'flex';
                });
                card.querySelector('.delete').addEventListener('click', async () => {
                    if (!elements.controlPanel.classList.contains('show')) {
                        showNotification('افتح لوحة التحكم أولاً');
                        return;
                    }
                    const category = appData[currentPanel].categories.find(c => c.name === categoryName);
                    const targetItem = category.items.find(i => i.id === item.id);
                    if (confirm(`هل تريد حذف "${targetItem.name}"؟`)) {
                        category.items = category.items.filter(i => i.id !== item.id);
                        renderItems();
                        await saveData();
                        showNotification('تم الحذف');
                    }
                });
                return card;
            }

            // Update dropdowns
            function updateParentCategoryDropdown(selectedId = '') {
                elements.parentCategory.innerHTML = '<option value="">لا يوجد قسم رئيسي</option>';
                if (currentPanel === 'candat') {
                    const mainCategories = appData.candat.categories.filter(c => !c.parentId);
                    mainCategories.forEach(category => {
                        if (category.id !== appData.candat.editingCategory) {
                            const option = document.createElement('option');
                            option.value = category.id;
                            option.textContent = category.name;
                            if (category.id === selectedId) option.selected = true;
                            elements.parentCategory.appendChild(option);
                        }
                    });
                }
            }

            function updateItemCategoryDropdown() {
                elements.itemCategory.innerHTML = '';
                appData[currentPanel].categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    if (appData[currentPanel].editingItem && appData[currentPanel].editingItem.categoryId === category.id) {
                        option.selected = true;
                    } else if (!appData[currentPanel].editingItem && appData[currentPanel].currentCategory === category.id) {
                        option.selected = true;
                    }
                    elements.itemCategory.appendChild(option);
                });
            }

            // Save category
            async function saveCategory() {
                const name = elements.categoryName.value.trim();
                const parentId = currentPanel === 'candat' ? elements.parentCategory.value || null : null;
                if (!name) {
                    showNotification('أدخل اسم القسم');
                    return;
                }
                const data = appData[currentPanel];
                if (data.editingCategory) {
                    const category = data.categories.find(c => c.id === data.editingCategory);
                    category.name = name;
                    if (currentPanel === 'candat') category.parentId = parentId;
                } else {
                    const newCategory = { id: generateId(), name, items: [], parentId };
                    data.categories.push(newCategory);
                    if (!data.currentCategory) data.currentCategory = newCategory.id;
                }
                renderCategories();
                renderCandatCategories();
                renderItems();
                elements.categoryModal.style.display = 'none';
                showNotification('تم الحفظ');
            }

            // Save item
            async function saveItem() {
                const name = elements.itemName.value.trim();
                const content = elements.itemContent.value.trim();
                const categoryId = elements.itemCategory.value;
                if (!name || !content) {
                    showNotification('أدخل اسم ومحتوى');
                    return;
                }
                const data = appData[currentPanel];
                const category = data.categories.find(c => c.id === categoryId);
                if (data.editingItem) {
                    const item = category.items.find(i => i.id === data.editingItem.itemId);
                    item.name = name;
                    item.content = content;
                    if (categoryId !== data.editingItem.categoryId) {
                        const oldCategory = data.categories.find(c => c.id === data.editingItem.categoryId);
                        oldCategory.items = oldCategory.items.filter(i => i.id !== data.editingItem.itemId);
                        category.items.push(item);
                    }
                } else {
                    const newItem = { id: generateId(), name, content };
                    category.items.push(newItem);
                }
                renderItems();
                elements.itemModal.style.display = 'none';
                showNotification('تم الحفظ');
            }

            // Export to Excel
            function exportToExcel() {
                const data = appData[currentPanel].categories.map(category =>
                    category.items.map(item => ({
                        Category: category.name,
                        Name: item.name,
                        Content: item.content
                    }))
                ).flat();
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, currentPanel);
                XLSX.writeFile(wb, `${currentPanel}_export.xlsx`);
            }

            // Import from Excel
            function importFromExcel(event) {
                const file = event.target.files[0];
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    appData[currentPanel].categories = [];
                    json.forEach(row => {
                        let category = appData[currentPanel].categories.find(c => c.name === row.Category);
                        if (!category) {
                            category = { id: generateId(), name: row.Category, items: [], parentId: null };
                            appData[currentPanel].categories.push(category);
                        }
                        category.items.push({
                            id: generateId(),
                            name: row.Name,
                            content: row.Content
                        });
                    });
                    if (appData[currentPanel].categories.length > 0) {
                        appData[currentPanel].currentCategory = appData[currentPanel].categories[0].id;
                    }
                    renderCategories();
                    renderCandatCategories();
                    renderItems();
                    await saveData();
                    showNotification('تم الاستيراد');
                };
                reader.readAsArrayBuffer(file);
            }

            // Export to JSON
            function exportToJson() {
                const data = JSON.stringify(appData, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'data.json';
                a.click();
                URL.revokeObjectURL(url);
            }

            // Import from JSON
            function importFromJson(event) {
                const file = event.target.files[0];
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        appData = jsonData;
                        if (appData.tags.categories.length > 0) appData.tags.currentCategory = appData.tags.categories[0].id;
                        if (appData.candat.categories.length > 0) appData.candat.currentCategory = appData.candat.categories[0].id;
                        renderCategories();
                        renderCandatCategories();
                        renderItems();
                        await saveData();
                        showNotification('تم الاستيراد');
                    } catch (error) {
                        showNotification('ملف JSON غير صالح');
                    }
                };
                reader.readAsText(file);
            }

            // Helper functions
            function generateId() {
                return Math.random().toString(36).substr(2, 9);
            }

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('تم النسخ');
                }).catch(() => {
                    showNotification('فشل النسخ');
                });
            }

            function showNotification(message) {
                elements.notification.textContent = message;
                elements.notification.classList.add('show');
                setTimeout(() => elements.notification.classList.remove('show'), 3000);
            }

            // Start the application
            initApp();
        });
    </script>
</body>
</html>
